<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <title>Box-in-Season</title><!-- 直訳で"旬な箱" -->
    <style>
        @font-face {font-family: comicsans;src: url(assets/comicsans.ttf);}
        @font-face {font-family: wingdings;src: url(assets/wingdings.ttf);}
        @font-face {font-family: genjuu;src: url(assets/genjuu.ttf);}
        /*こっから雑に扱ってもいい子*/
        #movabledescription {
        display: none;
        position: fixed;  /* 画面上の絶対位置に固定 */
        pointer-events: none;  /* マウスイベントを通過させる */
        background-color: rgba(90, 90, 90, 0.9);
        color: rgb(255, 255, 255);
        padding: 5px 10px;
        border-radius: 5px;
        z-index: 1000;  /* 他の要素の上に表示 */
        }

        /*こっから全体のやつ*/
        #body{
            font-family:comicsans;
            overflow-x: hidden;
            overflow-y: scroll;
            background-color: #f0f8ff;
        }

        /* こっからログインのやつ */
        #login{
            width: 500px;
            max-width: 100%;
            margin: 50px auto;
            background-color: #def0ff;
            border: 1px solid #b5dcff;
            border-radius: 5px;
            overflow: hidden;
            display: none;
            flex-direction: column;
            display: flex;
        }
        #login-form {
            padding: 20px;
        }
        #login-form input {
            width: calc(100% - 20px);
            margin-bottom: 10px;
            padding: 10px;
            font-size: 16px;
        }
        #login-form button {
            width: 100%;
            padding: 10px;
            background-color: #c8c8c8;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
        }
        #login-form button:hover {
            background-color: #8b8b8b;
        }

        /*こっから上のUI(upperUI)*/
        #upperUI{
            display: none;
            border-bottom: 3px solid #cfe9ff;
            background-color: #def0ff;
            position: relative;
            top: 0;
            left: 0;
            width: 100%;
            height: 7vh;
            z-index: 997;
        }
        #menuToggle{
            display: block;
            width:25px;
            height:25px;
            position: absolute;
            right:25px;
            top:5px;
            font-size:35px;
            cursor: pointer;
            z-index: 998;
        }
        #user{
            position: absolute;
            width: 150px;
            height: 100%;
            left: 2px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 998;
            background-color: #e6f4ff;
            text-align: left;
            overflow-x: scroll;
        }
        #Username{
            position: absolute;
            left: 10px;
            bottom: 20px;
            font-size: 16px;
            z-index: 999;
        }
        #Level{
            position: absolute;
            left: 10px;
            top: 0px;
            font-size: 16px;
            z-index: 999;
        }
    
        #expbar{
            position: absolute;
            width: 50%;
            height: 30px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 998;
            background-color: #4473ad;
            text-align: center;
        }
        #exp{
            position: absolute;
            width:0%;
            height: 24px;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background-color: #365172;
            z-index: 999;
            display: inline-block;
            vertical-align: middle;
        }
        #exptext{
            position:absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-size: 20px;
            color: #f0f8ff;
            display: inline-block;
            vertical-align: middle;
            z-index: 1000;
        }

        /*こっからsideMenu*/
        #sideMenu {
            position: fixed;
            top: 0;
            left: -250px;
            width: 250px;
            height: 100%;
            color: #333344;
            background-color: #def0ff!important;
            border-right: 3px solid #cfe9ff;
            transition: left 0.3s;
            z-index:999;
        };
        hr{
            background-color: #cfe9ff;
            border: 2px solid #cfe9ff;
        }
        #sideMenu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        };
        #sideMenu ul li {
            padding: 3px;
        };
        #sideMenu ul li a {
            color: #000000;
            text-decoration: none;
        };

        /*こっからmains*/
        #mains{
            margin-top: 7vh+20px;
        }
        #answer, #question, #search, #profile{
            display: none;
            width:100%;
            height: 90vh;
            background-color: #f0f8ff;
            padding-top: 10px;
        }

        /*こっからtab*/
        #tabs{
            font-family: wingdings;
            font-size: 35px;
            display: none;
            justify-content: space-between;
            padding: 10px;
            padding-left: 40px;
            padding-right: 40px;
            background-color: #def0ff;
            position: fixed;
            left:0;right:0;
            bottom:10px;
            z-index: 998;
        }
        .tab{
            cursor: pointer;
        }

        /*こっから既読/未読切り替えとかsとか*/
        #q-toggle, #a-toggle{
            display: block;
        }
        #a-toggle{
            margin-top:5px;
        }
        .toggle{    
            width: 90%;
            position: relative;
        }
        .toggle-unread{
            width: 45%;
            position: absolute;
            left: 5px;
            transition: background 0.3s, color 0.3s;
            cursor: pointer;
        }
        .toggle-read{
            width: 45%;
            position: absolute;
            right: 5px;
            transition: background 0.3s, color 0.3s;
            cursor: pointer;
        }

        .active {
            background: #b5dcff;
            color: #2b2b2b;
        }

        .unactive {
            background: #def0ff;
            color: #2b2b2b;
        }


        /*こっからquestion*/
        .question{
            border: 1px solid #b5dcff;
            background-color: #cfe9ff;
            width:85%;
            max-height: 80px;
            overflow-x: hidden;
            overflow-y: scroll;
            padding: 10px;
            padding-bottom: 30px;
            margin-bottom: 10px;
            position: relative;
        }
        .q-timestamp, .a-timestamp{
            position: absolute;
            left: 27px;
            bottom: 2px;
        }
        .q-mark, .a-mark{
            position: absolute;
            left: 3px;
            bottom: 2px;
            cursor: pointer;
        }
        .q-answer,.a-username,.q-delete{
            position: absolute;
            right: 2px;
            bottom: 2px;
        }
        

        /*こっからanswer*/
        #questions, #answers, #m-questions, #m-answers{
            margin-top: 30px;
        }
        #m-questions, #m-answers{
            display: none;
        }
        .answer{
            border: 1px solid #b5dcff;
            background-color: #cfe9ff;
            width:85%;
            max-height: 140px;
            overflow-x: hidden;
            overflow-y: scroll;
            padding: 10px;
            padding-bottom: 30px;
            margin-bottom: 15px;
            position: relative;
        }
        .a-timestamp{
            position: absolute;
            left: 2px;
            bottom: 2px;
        }
        .a-username{
            position: absolute;
            right: 2px;
            bottom: 2px;
        }
        .a-anchor{
            margin: 0 auto;
            text-align: left;
            padding:3px;
            background-color: #def0ff;
        }
        .a-text{
            margin: 0 auto;
            text-align: left;

        }

        /*こっからwq(write-question)*/
        #letswritequestion{
            width: 95%;
            height: 40px;
            background-color: #cfe9ff;
            border: 3px solid #b5dcff;
            padding: 10px;
            font-size: 23px;
            margin: 0 auto;
            text-align: center;
            cursor: pointer;
        }
        #wq-zone{
            display: block;
            position: fixed;
            width: 80%;
            height: 100vh;
            right: -80%;
            top:0;
            z-index: 999;
            
            background-color: #def0ff;
            border-left: 3px solid #cfe9ff;
            color:#333444;
            transition: right 0.3s;
        }
        #wq-zone-header{
            display: flex;
            justify-content: space-between;
            padding: 10px;
            padding-left: 20px;
            padding-right: 20px;
        }
        #wq-zone-body{
            padding: 10px;
            padding-left: 20px;
            padding-right: 20px;
        }
        #wq-sender-name{
            display: none;
            border: 2px solid #cfe9ff;
            height: 23px;
            position: relative;
        }
        #wq-sender-name-area{
            position: absolute;
            left: 0px;
            top: 0px;
            
        }
        #wq-sender-name-cansel{
            position: absolute;
            right: 5px;
            top: 1px;
            bottom: 1px;
            cursor: pointer;
        }
        #wq-sender-search-area, #wq-sender-search-result{
            border: 2px solid #cfe9ff;

        }
        #wq-text{
            border: 3px solid #cfe9ff;
            height: 75vh;
        }


        #wa-zone{
            display: block;
            position: fixed;
            width: 80%;
            height: 100vh;
            right: -80%;
            top:0;
            z-index: 999;
            
            background-color: #def0ff;
            border-left: 3px solid #cfe9ff;
            color:#333444;
            transition: right 0.3s;
        }
        #wa-zone-header{
            display: flex;
            justify-content: space-between;
            padding: 10px;
            padding-left: 20px;
            padding-right: 20px;
        }
        #wa-zone-body{
            padding: 10px;
            padding-left: 20px;
            padding-right: 20px;
        }
        #wa-sender-name{
            display: none;
            border: 2px solid #cfe9ff;
            height: 23px;
            position: relative;
        }
        #wa-sender-name-area{
            position: absolute;
            left: 0px;
            top: 0px;
            
        }
        #wa-key{
            display: none;
        }
        #wa-anchor{          
            border: 2px solid #cfe9ff;
            max-height: 80px;
            overflow-x: hidden;
            overflow-y: scroll
        }
        #wa-text{
            border: 3px solid #cfe9ff;
            height: 75vh;
        }

    </style>
</head>
<body id="body">
    <div id="login">
        <div id="login-form">
            <input type="text" id="username" placeholder="username">
            <input type="password" id="password" placeholder="password">
            <button id="login-button">Login</button>
        </div>
    </div>

    <div id="upperUI">
        <div id="user">
            <div id="Username">no name</div>
            <div id="Level">Lv:1</div>
        </div>
        <div id="expbar">
            <div id="exp"></div>
            <div id="exptext">0/NaN</div>
        </div>
        <div id="menuToggle">☰</div>
    </div>
    <div id="mains">
        <div id="answer" class="main">
            <div id="wa-zone">
                <div id="wa-zone-header">
                    <div id="wa-cansel">キャンセル</div>
                    <div id="wa-send">送信</div>
                </div>
                <div id="wa-zone-body">
                    <div id="wa-sender">
                        <div id="wa-sender-name">
                            <div id="wa-sender-name-area"></div>
                        </div>
                        <div id="wa-key"></div>
                    </div>
                    <div id="wa-anchor"></div>
                    <div id="wa-text" contenteditable="true"></div>
                </div>
            </div>
            <div id="q-toggle" class="toggle">
                <div id="q-toggle-unread" class="toggle-unread toggle active" data-mark="unread">unRead</div>
                <div id="q-toggle-read" class="toggle-read toggle unactive" data-mark="read">Read</div>
            </div>
            <div id="questions"></div>
            <div id="m-questions"></div>
        </div>
        <div id="question" class="main">
            <div id="wq-zone">
                <div id="wq-zone-header">
                    <div id="wq-cansel">キャンセル</div>
                    <div id="wq-send">送信</div>
                </div>
                <div id="wq-zone-body">
                    <div id="wq-sender">
                        <div id="wq-sender-name">
                            <div id="wq-sender-name-area"></div>
                            <div id="wq-sender-name-cansel">x</div>
                        </div>
                        <div id="wq-sender-search">
                            <div id="wq-sender-search-area" contenteditable="true"></div>
                            <div id="wq-sender-search-result"></div>
                        </div>
                    </div>
                    <div id="wq-text" contenteditable="true"></div>
                </div>
            </div>
            <div id="letswritequestion">質問を送信</div>
            <div id="a-toggle" class="toggle">
                <div id="a-toggle-unread" class="toggle-unread toggle active" data-mark="unread">unRead</div>
                <div id="a-toggle-read" class="toggle-read toggle unactive" data-mark="read">Read</div>
            </div>
            <div id="answers"></div>
            <div id="m-answers"></div>
        </div>
        <div id="search" class="main">ｻｧﾝ<br><br>ここ要らない気がしてきた<br>blackjackとか作る？ww</div>
        <div id="profile" class="main">4</div>
    </div>
    <div id="tabs">
        <div id="answer-tab" class="tab">/</div>
        <div id="question-tab" class="tab">!</div>
        <div id="search-tab" class="tab">:</div>
        <div id="profile-tab" class="tab">+</div>
    </div>

    <nav id="sideMenu">
        <hr>
        <ul>
            <li><a href="home.html">to home</a></li>
            <li><a href="memo.html">to memo</a></li>
            <li><a href="https://koppepan-orange.github.io/game-site/welcome.html">to game</a></li>
            <li><a href="hidden.html">to hidden</a></li>
        </ul>
        <hr>
    </nav>
    <div id="movabledescription"></div>
    <script src="library.js"></script>
    <script>
        //#region documentの子たち
        const Mains = document.getElementById('mains');
        const Answer = document.getElementById('answers');
        const Question = document.getElementById('questions');
        const Search = document.getElementById('search');
        const Profile = document.getElementById('profile');

        const Tabs = document.getElementById('tabs');
        const answerTab = document.getElementById('answer-tab');
        const questionTab = document.getElementById('question-tab');
        const searchTab = document.getElementById('search-tab');
        const profileTab = document.getElementById('profile-tab');

        const upperUI = document.getElementById('upperUI');
        const menuToggle = document.getElementById('menuToggle');
        const sideMenu = document.getElementById('sideMenu');
        //#endregion
        //#region 色々雑に扱ってもいい子達
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function copy(obj) {
            if (obj === null || typeof obj !== 'object') return obj;
            if (Array.isArray(obj)) return obj.map(copy);
            const result = {};
            for (const key in obj) {
                if (obj.hasOwnProperty(key)) {
                    result[key] = copy(obj[key]);
                }
            }
            return result;
        }

        function arraySelect(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        function arrayShuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function setLocalStorage(name, value) {
            localStorage.setItem(name, value || ""); // 値が空なら空文字を入れる
        }

        function getLocalStorage(name){
            return localStorage.getItem(name); // 値をそのまま返す、ない場合はnull
        }


        document.addEventListener('mousemove', (e) => {
            const HasDescription = document.getElementById('movabledescription');
            if (HasDescription) {
                HasDescription.style.left = `${e.clientX + 10}px`;
                HasDescription.style.top = `${e.clientY + 10}px`;
            }
        });

        document.addEventListener('mouseover', (e) => {
            if (e.target.classList.contains('hasd')) {
                const movabledescription = e.target.dataset.description;
                const descElement = document.getElementById('movabledescription');
                if (descElement) {
                    descElement.innerHTML = movabledescription;
                    descElement.style.display = 'block';
                }
            }
        });

        document.addEventListener('mouseout', (e) => {
            if (e.target.classList.contains('hasd')) {
                const descElement = document.getElementById('movabledescription');
                if (descElement) {
                    descElement.innerHTML = '';
                    descElement.style.display = 'none';
                }
            }
        });

        async function NicoNicoText(mes) {
            const newDiv = document.createElement('div');
            newDiv.textContent = mes;
            newDiv.style = `
                position: absolute;
                top: ${Math.random() * 100}vh;
                right: 0;
                background-color: rgba(228, 249, 255, 0.563);
                color: #000000;
                font-size: 20px;
            `;
            document.body.appendChild(newDiv);
            let speed = 10;
            for (let i = 0; window.innerWidth > i * speed; i++) {
                let val = i * speed;
                newDiv.style.right = `${val}px`;
                await delay(50);
            }
            newDiv.remove();
        }

        menuToggle.addEventListener('click', () => {
            if(sideMenu.style.left === '0px'){
                sideMenu.style.left = '-250px';
            }else{
                sideMenu.style.left = '0px';
            }
        });

        document.addEventListener('mousemove', (e) => {
            const HasDescription = document.getElementById('movabledescription');
            HasDescription.style.left = `${e.clientX + 10}px`;
            HasDescription.style.top = `${e.clientY + 10}px`;
        });

        document.addEventListener('mouseover', (e) => {
            if(e.target.classList.contains('hasd')){
                const description = e.target.dataset.description;
                document.getElementById('movabledescription').innerHTML = description;
                document.getElementById('movabledescription').style.display = 'block';
            }
        });
        document.addEventListener('mouseout', (e) => {
            if(e.target.classList.contains('hasd')){
                document.getElementById('movabledescription').innerHTML = '';
                document.getElementById('movabledescription').style.display = 'none';
            }
        });

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}/${month}/${day} ${hours}:${minutes}`;
        }
        function formatTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const time = `${year}${month}${day}${hours}${minutes}`;
            return +time;
        }
        function motonimodore(now){
            const year = Math.floor(now / 10000000000); // 2025
            const month = Math.floor((now % 10000000000) / 100000000) - 1; // 1 (0から始まるため、2月は1)
            const day = Math.floor((now % 100000000) / 1000000); // 5
            const hours = Math.floor((now % 10000) / 100); // 7
            const minutes = now % 100; // 33

            // Dateオブジェクトを作成
            return new Date(year, month, day, hours, minutes);
        }
        function getTimestamp(time){
            let from = formatTime(new Date(time));
            let now = formatTime(new Date());

            let asfrom = motonimodore(from);
            let asnow = motonimodore(now);

            let diffMs = asnow - asfrom;
            let diffMin = Math.floor(diffMs / (1000 * 60));
            let diffHour = Math.floor(diffMs / (1000 * 60 * 60));
            let diffDay = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            let diffMonth = (asnow.getFullYear() - asfrom.getFullYear()) * 12 + asnow.getMonth() - asfrom.getMonth(); // 月差分計算
            let diffYear = asnow.getFullYear() - asfrom.getFullYear();

            if(diffMin < 60){
                return `${diffMin}分前`;
            }else if(diffHour < 24){
                return `${diffHour}時間前`;
            }else if(diffDay < 30){ // 30日未満なら「日」
                return `${diffDay}日前`;
            }else if(diffMonth < 12){ // 12ヶ月未満なら「月」
                return `${diffMonth}ヶ月前`;
            }else{ // それ以上なら「年」
                return `${diffYear}年前`;
            }
        }
        function save(){
            myRef.update({
                level:level,
                exp:exp
            })
        }
        //#endregion
        //#region tab-select
        let datas = {
            'answer':{
                'open':'.',// /
                'close':'-'// ,
            },
            'question':{
                'open':'?',
                'close':'!'
            },
            'search':{
                'open':':',
                'close':':'
            },
            'profile':{
                'open':'+',
                'close':'+'
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.tab').forEach(tab => {
                let id = tab.id;
                tab.dataset.open = datas[id.substring(0, id.length - 4)].open;
                tab.dataset.close = datas[id.substring(0, id.length - 4)].close;
            })
            autoLogin();
        })
        
        document.querySelectorAll('.tab').forEach(ele => {
            ele.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(tab => {
                    let id = tab.id.substring(0, tab.id.length - 4);
                    document.getElementById(id).style.display = 'none';
                    document.getElementById(`${id}-tab`).textContent = tab.dataset.close;
                })
                document.getElementById(ele.id.substring(0,ele.id.length-4)).style.display = 'block';
                ele.textContent = ele.dataset.open;
            })
        })
        //#endregion
        //#region firebase-設定とかmoromoro
        const firebaseConfig = {
            apiKey: "AIzaSyBN5V_E6PzwlJn7IwVsluKIWNIyathhxj0",
            authDomain: "koppepan-orange.firebaseapp.com",
            databaseURL: "https://koppepan-orange-default-rtdb.firebaseio.com",
            projectId: "koppepan-orange",
            storageBucket: "koppepan-orange.appspot.com",
            messagingSenderId: "730150198097",
            appId: "1:730150198097:web:076a074a3d406053155170",
            measurementId: "G-MYKJWD203Z"
        };
        firebase.initializeApp(firebaseConfig);
        var database = firebase.database();

        let username = 'no name';
        let myquestionRef = database.ref(`users/${username}/BoxinSeason/questions`);
        let myanswerRef = database.ref(`users/${username}/BoxinSeason/answers`);
        let myRef = database.ref(`users/${username}/BoxinSeason`);
        let usersRef = database.ref(`users/${username}`);

        let qcurrentRef = myquestionRef;let acurrentRef = myanswerRef;

        //#region ログインの動き
        function login(){
            document.getElementById('login').style.display = 'none';
            upperUI.style.display = 'block';
            Tabs.style.display = 'flex';
            answerTab.click();
            nowtab = 'Question';

            usersRef = database.ref('users/'+username);
            myRef = database.ref(`users/${username}/BoxinSeason`);
            myquestionRef = database.ref(`users/${username}/BoxinSeason/questions`);
            myanswerRef = database.ref(`users/${username}/BoxinSeason/answers`);

            myRef.once('value', function(snapshot){
                if(snapshot.exists()){
                    const userData = snapshot.val();
                    level = userData.level;
                    exp = userData.exp;
                    maxexp = exp*level+50;
                    updateUI();
                }
            })

            myquestionRef.once('value', function(snapshot){
                if(snapshot.exists()){
                    let data = snapshot.val();
                    let keys = Object.keys(data);
                    keys.forEach(key => {
                        if(data[key].mark == false){
                            let questionElement = makeQuestion(data[key],key);
                            questionElement.setAttribute('data-dokosan', '最初の読み込み');
                            let existing = document.querySelector(`#questions .question[data-key="${key}"]`);
                            if(existing){
                                console.log("重複してるぜ〜〜〜〜〜乙〜〜〜〜〜〜〜〜〜〜〜〜:", key);
                                return;
                            }
                            Question.appendChild(questionElement);
                        }else{
                            let questionElement = mmakeQuestion(data[key],key);
                            questionElement.setAttribute('data-dokosan', '最初の読み込み');
                            let existing = document.querySelector(`#m-questions .question[data-key="${key}"]`);
                            if(existing){
                                console.log("重複してるぜ。けどこれ既読のやつだぜ:", key);
                                return;
                            }
                            document.getElementById('m-questions').appendChild(questionElement);
                        }

                    })
                }
            })

            myanswerRef.once('value', function(snapshot){
                if(snapshot.exists()){
                    let data = snapshot.val();
                    let keys = Object.keys(data);
                    keys.forEach(key => {
                        let answerElement = makeAnswer(data[key],key);
                        answerElement.setAttribute('data-dokosan', '最初の読み込み');
                        let existing = document.querySelector(`#answers .answer[data-key="${key}"]`);
                        if(existing){
                            console.log("重複してるぜ〜〜〜〜〜乙〜〜〜〜〜〜〜〜〜〜〜〜:", key);
                            return; // 追加をキャンセル
                        }
                        Answer.appendChild(answerElement);
                    })
                }
            })

            updateQuestionRef(myquestionRef);
            updateAnswerRef(myanswerRef);
        }

        document.getElementById('login-button').addEventListener('click', () => {
            let username = document.getElementById('username').value;
            let password = document.getElementById('password').value;

            document.getElementById('username').value = '';
            document.getElementById('password').value = '';

            let kariusersRef = database.ref(`users/${username}`);
            kariusersRef.once('value', function(snapshot){
                if(snapshot.exists()){
                    if(snapshot.val().password == password){
                        setLocalStorage("username", username)
                        login();   
                    }
                }else{
                    let usersRef = database.ref(`users/${username}`);
                    usersRef.update({
                        password:password,
                        banned: 0,
                        blocked: [],
                    })
                    NicoNicoText('ようこそ');
                    setLocalStorage("username", username)
                    login();
                }
            })
        })

        function autoLogin(){
            username = getLocalStorage("username");
            if(username){
                console.log("自動ログインしました");
                login();
            }else{
                console.log("ログインしてください");
            }
        }
        //#endregion
        //#endregion
        //#region active-unactive
        document.addEventListener('click', event =>{
            if(event.target.classList.contains('toggle')){
                if(event.target.id == 'q-toggle-read' && event.target.classList.contains('unactive')){
                    event.target.classList.remove('unactive');
                    event.target.classList.add('active');
                    document.getElementById('q-toggle-unread').classList.remove('active');
                    document.getElementById('q-toggle-unread').classList.add('unactive');
                    document.getElementById('questions').style.display = 'none';
                    document.getElementById('m-questions').style.display = 'block';
                }else if(event.target.id == 'q-toggle-unread' && event.target.classList.contains('unactive')){
                    event.target.classList.remove('unactive');
                    event.target.classList.add('active');
                    document.getElementById('q-toggle-read').classList.remove('active');
                    document.getElementById('q-toggle-read').classList.add('unactive');
                    document.getElementById('questions').style.display = 'block';
                    document.getElementById('m-questions').style.display = 'none';
                }else if(event.target.id == 'a-toggle-read' && event.target.classList.contains('unactive')){
                    event.target.classList.remove('unactive');
                    event.target.classList.add('active');
                    document.getElementById('a-toggle-unread').classList.remove('active');
                    document.getElementById('a-toggle-unread').classList.add('unactive');
                    document.getElementById('answers').style.display = 'none';
                    document.getElementById('m-answers').style.display = 'block';
                }else if(event.target.id == 'a-toggle-unread' && event.target.classList.contains('unactive')){
                    event.target.classList.remove('unactive');
                    event.target.classList.add('active');
                    document.getElementById('a-toggle-read').classList.remove('active');
                    document.getElementById('a-toggle-read').classList.add('unactive');
                    document.getElementById('answers').style.display = 'block';
                    document.getElementById('m-answers').style.display = 'none';
                }
            }
        })
        //#endregion
        //#region question  
        let qchildAddedListener;
        function updateQuestionRef(newRef) {
            if (qchildAddedListener) {
                qcurrentRef.off('child_added', qchildAddedListener);
            }

            qcurrentRef = newRef;

            // 新しいリスナーを設定
            qchildAddedListener = qcurrentRef.on('child_added', function(snapshot) {
                if (snapshot.exists()) {
                    let data = snapshot.val();
                    let key = snapshot.key;
                    if(data.mark == false){
                        let questionElement = makeQuestion(data, key);
                        questionElement.setAttribute('data-dokosan', '追加された時の読み込み');
                        let existing = document.querySelector(`#questions .question[data-key="${key}"]`);
                        if(existing){
                            console.log("重複してるぜ〜〜〜〜〜乙〜〜〜〜〜〜〜〜〜〜〜〜:", key);
                            return; // 追加をキャンセル
                        }
                        Question.appendChild(questionElement);
                    }else{
                        let questionElement = mmakeQuestion(data, key);
                        questionElement.setAttribute('data-dokosan', '追加された時の読み込み');
                        let existing = document.querySelector(`#m-questions .question[data-key="${key}"]`);
                        if(existing){
                            console.log("重複してるぜ〜〜〜〜〜乙〜〜〜〜〜〜〜〜〜〜〜〜:", key);
                            return;
                        }
                        document.getElementById('m-questions').appendChild(questionElement);
                    }
                }
            }); 
        }

        function makeQuestion(data,key){
            let question = data;
            let questionElement = document.createElement('div');
            questionElement.className = 'question';
            questionElement.setAttribute('data-from', data.from); //ブロックとかする用。でも有識者の場合匿名が剥がれる
            questionElement.setAttribute('data-time', data.time);
            questionElement.setAttribute('data-key', key);

            let timestamp = getTimestamp(data.time);
            let timestampElement = document.createElement('div');
            timestampElement.className = 'q-timestamp';
            timestampElement.textContent = timestamp;
            questionElement.appendChild(timestampElement);
            
            let textElement = document.createElement('div');
            textElement.className = 'q-text';
            textElement.innerText = data.text
            questionElement.appendChild(textElement);

            let markElement = document.createElement('div');
            markElement.className = 'q-mark';
            markElement.textContent = '√';
            questionElement.appendChild(markElement);

            let buttonElement = document.createElement('button');
            buttonElement.className = 'q-answer';
            buttonElement.textContent = 'answer this';
            questionElement.appendChild(buttonElement);

            return questionElement
        }

        document.querySelector("#questions").addEventListener("click", function(event) {
            if(event.target.classList.contains("q-mark")){
                let question = event.target.parentElement;
                let dataKey = question.getAttribute("data-key");
                let textdiv = question.querySelector('.q-text');
                let timestampdiv = question.querySelector('.q-timestamp');
                
                let data = {
                    from: question.getAttribute("data-from"),
                    to: username,
                    timestamp: timestampdiv.innerText,
                    text: textdiv.innerText,
                    key: question.getAttribute("data-key"),
                    time: question.getAttribute("data-time")
                }

                question.remove(); //divを削除(not firebase)
                
                let key = data.key;
                let questionElement = mmakeQuestion(data, key);
                questionElement.setAttribute('data-dokosan', '今さっき既読にされたんすよ');
                let existing = document.querySelector(`#m-questions .question[data-key="${key}"]`);
                if(existing){
                    console.log("重複してるぜ〜〜〜〜〜乙〜〜〜〜〜〜〜〜〜〜〜〜:", key);
                    return; // 追加をキャンセル
                }
                document.getElementById('m-questions').appendChild(questionElement);

                firebase.database().ref(`users/${username}/BoxinSeason/questions/${dataKey}`).update({
                    mark: true
                })
            }
        });

        document.querySelector("#m-questions").addEventListener("click", function(event) {
            if(event.target.classList.contains("q-mark")){
                let question = event.target.parentElement;
                let dataKey = question.getAttribute("data-key");
                let textdiv = question.querySelector('.q-text');
                let timestampdiv = question.querySelector('.q-timestamp');
                
                let data = {
                    from: question.getAttribute("data-from"),
                    to: username,
                    timestamp: timestampdiv.innerText,
                    text: textdiv.innerText,
                    key: question.getAttribute("data-key"),
                    time: question.getAttribute("data-time")
                }

                question.remove(); //divを削除(not firebase)
                
                let key = data.key;
                let questionElement = makeQuestion(data, key);
                questionElement.setAttribute('data-dokosan', '今さっき既読にされたんすよ');
                let existing = document.querySelector(`#questions .question[data-key="${key}"]`);
                if(existing){
                    console.log("重複してるぜ〜〜〜〜〜乙〜〜〜〜〜〜〜〜〜〜〜〜:", key);
                    return; // 追加をキャンセル
                }
                document.getElementById('questions').appendChild(questionElement);

                firebase.database().ref(`users/${username}/BoxinSeason/questions/${dataKey}`).update({
                    mark: false
                })
            }else if(event.target.classList.contains("q-delete")){
                let question = event.target.parentElement;
                let dataKey = question.getAttribute("data-key");

                firebase.database().ref(`users/${username}/BoxinSeason/questions/${dataKey}`).remove()
                .then(() => {
                    question.remove();
                })
            }
        });

        function mmakeQuestion(data,key){
            let question = data;
            let questionElement = document.createElement('div');
            questionElement.className = 'question';
            questionElement.setAttribute('data-from', data.from);
            questionElement.setAttribute('data-time', data.time);
            questionElement.setAttribute('data-key', key);

            let timestampElement = document.createElement('div');
            timestampElement.className = 'q-timestamp';
            timestampElement.textContent = data.timestamp;
            questionElement.appendChild(timestampElement);
            
            let textElement = document.createElement('div');
            textElement.className = 'q-text';
            textElement.innerText = data.text
            questionElement.appendChild(textElement);

            let markElement = document.createElement('div');
            markElement.className = 'q-mark';
            markElement.textContent = 'x';
            questionElement.appendChild(markElement);

            let buttonElement = document.createElement('button');
            buttonElement.className = 'q-delete';
            buttonElement.textContent = 'delete this';
            questionElement.appendChild(buttonElement);

            return questionElement
        }


        //#endregion
        //#region answer
        let achildAddedListener;
        function updateAnswerRef(newRef){
            if(achildAddedListener){
                acurrentRef.off('child_added', achildAddedListener);
            }

            acurrentRef = newRef;

            // 新しいリスナーを設定
            achildAddedListener = acurrentRef.on('child_added', function(snapshot) {
                if (snapshot.exists()) {
                    let data = snapshot.val();
                    let key = snapshot.key;
                    if(data.mark == false){
                        let answerElement = makeAnswer(data, key);
                        answerElement.setAttribute('data-dokosan', '追加された時の読み込み');
                        let existing = document.querySelector(`#answers .answer[data-key="${key}"]`);
                        if(existing){
                            console.log("重複してるぜ〜〜〜〜〜乙〜〜〜〜〜〜〜〜〜〜〜〜:", key);
                            return; // 追加をキャンセル
                        }
                        Answer.appendChild(answerElement);        
                    }else{
                        let answerElement = mmakeAnswer(data, key);
                        answerElement.setAttribute('data-dokosan', '追加された時の読み込み');
                        let existing = document.querySelector(`#m-answers .answer[data-key="${key}"]`);
                        if(existing){
                            console.log("重複してるぜ〜〜〜〜〜乙〜〜〜〜〜〜〜〜〜〜〜〜:", key);
                            return;
                        }
                        document.getElementById('m-answers').appendChild(answerElement);
                    }
                }
            })
        }

        function makeAnswer(data,key){
            let answer = data;
            let answerElement = document.createElement('div');
            answerElement.className = 'answer';
            answerElement.setAttribute('data-from', data.from); //ブロックとかする用。でも有識者の場合匿名が剥がれる
            answerElement.setAttribute('data-time', data.time);
            answerElement.setAttribute('data-key', key);

            let usernameElement = document.createElement('div');
            usernameElement.className = 'a-username';
            usernameElement.textContent = data.from;
            answerElement.appendChild(usernameElement);

            let timestamp = getTimestamp(data.time);
            let timestampElement = document.createElement('div');
            timestampElement.className = 'a-timestamp';
            timestampElement.textContent = timestamp;
            answerElement.appendChild(timestampElement);

            let anchorElement = document.createElement('div');
            anchorElement.className = 'a-anchor';
            anchorElement.innerText = data.anchor;
            answerElement.appendChild(anchorElement);
            
            let textElement = document.createElement('div');
            textElement.className = 'a-text';
            textElement.innerText = data.text
            answerElement.appendChild(textElement);

            return answerElement
        }
        
        
        document.querySelector("#answers").addEventListener("click", function(event) {
            if (event.target.classList.contains("a-mark")){
                let answer = event.target.parentElement;
                let dataKey = answer.getAttribute("data-key");

                let timestampdiv = answer.querySelector(".a-timestamp");
                let textdiv = answer.querySelector(".a-text");
                let anchordiv = answer.querySelector(".a-anchor");

                let data = {
                    from: username,
                    to: answer.getAttribute("data-from"),
                    timestamp: timestampdiv.innerText,
                    text: textdiv.innerText,
                    anchor: anchordiv.innerText,
                    key: answer.getAttribute("data-key"),
                    time: answer.getAttribute("data-time")
                }

                answer.remove(); //divを削除(not firebase)
                
                let key = data.key;
                let answerElement = mmakeAnswer(data, key);
                answerElement.setAttribute('data-dokosan', '今さっき既読にされたんすよ');
                let existing = document.querySelector(`#m-answers .answer[data-key="${key}"]`);
                if(existing){
                    console.log("重複してるぜ〜〜〜〜〜乙〜〜〜〜〜〜〜〜〜〜〜〜:", key);
                    return; // 追加をキャンセル
                }
                document.getElementById('m-answers').appendChild(answerElement);

                firebase.database().ref(`users/${username}/BoxinSeason/answers/${dataKey}`).update({
                    mark: true
                })

            }
        });

        document.querySelector("#m-answers").addEventListener("click", function(event) {
            if (event.target.classList.contains("a-mark")){
                let answer = event.target.parentElement;
                let dataKey = question.getAttribute("data-key");

                answer.remove(); //divを削除(not firebase)

                firebase.database().ref(`users/${username}/BoxinSeason/answers/${dataKey}`).remove()
                .then(() => {
                    answer.remove();
                })
            }
        });

        function mmakeAnswer(data,key){
            let answer = data;
            let answerElement = document.createElement('div');
            answerElement.className = 'answer';
            answerElement.setAttribute('data-from', data.from);
            answerElement.setAttribute('data-time', data.time);
            answerElement.setAttribute('data-key', key);

            let usernameElement = document.createElement('div');
            usernameElement.className = 'a-username';
            usernameElement.textContent = data.from;
            answerElement.appendChild(usernameElement);

            let timestampElement = document.createElement('div');
            timestampElement.className = 'a-timestamp';
            timestampElement.textContent = data.timestamp;
            answerElement.appendChild(timestampElement);
            
            let anchorElement = document.createElement('div');
            anchorElement.className = 'a-anchor';
            anchorElement.innerText = data.anchor;
            answerElement.appendChild(anchorElement);

            let textElement = document.createElement('div');
            textElement.className = 'a-text';
            textElement.innerText = data.text
            answerElement.appendChild(textElement);

            return answerElement
        }

        //#endregion
        //#region write-question
        document.getElementById('letswritequestion').addEventListener('click', () => {
            document.getElementById('wq-text').value = '';
            document.getElementById('wq-zone').style.right = '0';

            document.getElementById('wq-sender-name').style.display = 'none';
            document.getElementById('wq-sender-name-area').textContent = '';
            document.getElementById('wq-sender-search-area').style.display = 'block';
            document.getElementById('wq-sender-search-result').innerHTML = '';
            document.getElementById('wq-sender-search-result').style.display = 'none';
            //押された時にsytle通りにnonetobぉckyattoite

        })
        document.getElementById('wq-cansel').addEventListener('click', () => {
            document.getElementById('wq-text').value = '';
            document.getElementById('wq-zone').style.right = '-80%';
        })
        document.getElementById('wq-send').addEventListener('click', () => {
            let text = document.getElementById('wq-text').innerText.trim();
            if(!text){document.getElementById('wq-zone').style.right = '-80%';return;}
            let time = Date.now();
            let question = {
                from: username,
                to: sender,
                time: time,
                text: text,
                mark: false
            }
            let senderRef = database.ref(`users/${sender}/BoxinSeason/questions`);
            senderRef.push(question);
            document.getElementById('wq-zone').style.right = '-80%';
        })

        document.getElementById('wq-sender-search-area').addEventListener('keydown', (event) => {
            if(event.key !== 'Enter')return;
            event.preventDefault(); // フォームのリロードを防ぐ

            let sendersearch = document.getElementById('wq-sender-search-area').innerText.trim().toLowerCase();
            if (!sendersearch) return;

            let sendersRef = database.ref('users');

            sendersRef.orderByChild('username').startAt(sendersearch).endAt(sendersearch + "\uf8ff").once('value', (snapshot) => {
                let results = snapshot.val();
                let resultList = document.getElementById('wq-sender-search-result');
                resultList.innerHTML = ''; // 検索結果をクリア
                resultList.style.display = 'block';

                if (results) {
                    Object.keys(results).forEach(userId => {
                        let user = results[userId];
                        let listItem = document.createElement('li');
                        listItem.innerText = user.username;
                        listItem.onclick = () => {
                            sender = user.username;
                            document.getElementById('wq-sender-search-area').innerText = '';
                            document.getElementById('wq-sender-search-area').style.display = 'none';
                            document.getElementById('wq-sender-search-result').style.display = 'none';
                            document.getElementById('wq-sender-name').style.display = 'block';
                            document.getElementById('wq-sender-name-area').textContent = sender;
                        };
                        resultList.appendChild(listItem);
                    });
                } else {
                    resultList.innerHTML = '<li>該当なし</li>';
                }
            });
        });
        document.getElementById('wq-sender-name-cansel').addEventListener('click', () => {
            sender = '';
            document.getElementById('wq-sender-name-cansel').style.display = 'none';
            document.getElementById('wq-sender-name-area').textContent = '';
            document.getElementById('wq-sender-name').style.display = 'block';
            document.getElementById('wq-sender-search-area').style.display = 'block';
        })
        //#endregion
        //#region write-answer
        document.addEventListener('click', element =>{
            if(element.target.classList.contains('q-answer')){
                document.getElementById('wa-zone').style.right = '0';
                document.getElementById('wa-text').value = '';

                let questionKey = element.target.parentElement.dataset.key;
                sender = element.target.parentElement.dataset.from;
                let question = element.target.parentElement;
                
                document.getElementById('wa-sender-name-area').textContent = sender;
                
                document.getElementById('wa-anchor').innerText = question.querySelector('.q-text').innerText;
                document.getElementById('wa-key').innerText = question.getAttribute('data-key');
            }
        });
        document.getElementById('wa-cansel').addEventListener('click', () => {
            document.getElementById('wa-text').value = '';
            document.getElementById('wa-zone').style.right = '-80%';
        })
        document.getElementById('wa-send').addEventListener('click', () => {
            let text = document.getElementById('wa-text').innerText.trim();
            if(!text){document.getElementById('wa-zone').style.right = '-80%';return;}
            let time = Date.now();
            let anchor = document.getElementById('wa-anchor').innerText.trim();
            let answer = {
                from: username,
                to: sender,
                time: time,
                text: text,
                anchor: anchor,
                mark: false
            }
            let senderRef = database.ref(`users/${sender}/BoxinSeason/answers`);
            senderRef.push(answer);
            document.getElementById('wa-zone').style.right = '-80%';

            //questionから削除
            let key = document.getElementById('wa-key').textContent;
            let questionRef = database.ref(`users/${username}/BoxinSeason/questions/${key}`);
            questionRef.remove();
            
            let existing = document.querySelector(`#questions .question[data-key="${key}"]`);
            if(existing){
                existing.remove();
            }

            exp += 25;
            updateUI();
        })
        //#endregion
        //#region expとか
        let level = 1;
        let exp = 0;
        let maxexp = 50;
        let expbar = document.getElementById('exp');
        let exptext = document.getElementById('exptext');
        function updateUI(){
            if(exp >= maxexp){
                exp -= maxexp;
                level += 1;
                maxexp += 25;
            }

            expbar.style.width = `${exp/maxexp}%`;
            exptext.innerText = `${exp}/${maxexp}`
            document.getElementById('Username').textContent = username;
            document.getElementById('Level').textContent = `Lv:${level}`;

            save();
        }
        //#endregion
</script>
</body>
</html>